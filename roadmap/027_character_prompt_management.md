# 027: キャラクタープロンプト管理

## 規模: M (中)

## 概要
キャラクターごとのプロンプトテンプレート、参照画像、LoRA設定を管理し、AI生成時にワンクリックでプロンプトに挿入できる機能。マンガ全体でキャラクターの見た目を一貫させる。

## 現状の問題
- 同じキャラクターを複数コマで生成する際、毎回プロンプトを手入力
- キャラクターの外見設定（髪色、服装、特徴）をどこにも保存できない
- コマごとにプロンプトが微妙に違い、キャラの見た目がブレる
- LoRAの指定を毎回手動で行う必要がある

## 修正内容
### キャラクター登録
- キャラクター名、サムネイル画像
- 外見プロンプト（常に挿入される基本プロンプト）
  - 例: `1girl, long black hair, red eyes, school uniform`
- 表情バリエーション（オプション選択式）
  - 例: `smile`, `angry`, `crying`, `surprised`
- LoRA設定（モデル名、トリガーワード、ウェイト）
- 参照画像（複数枚登録可能）

### プロンプト挿入
- AI生成パネルにキャラクター選択ドロップダウンを追加
- 選択したキャラクターのプロンプトを自動挿入
- 複数キャラクター対応（`2girls`等に自動変換）

### 永続化
- IndexedDBに保存
- キャラクターデータのインポート/エクスポート（JSON形式）

## UI設計

### 操作フロー
```
1. 左サイドバーに「キャラ」アイコンを追加（17番目のタブ）
2. クリックすると left_area にキャラ管理パネルが開く
3. キャラを選択 → 右パネルのプロンプトに自動挿入
```

### サイドバーパネル（left_area）
`#sidebar`に新しい`.icon-wrapper`を追加。`toggleVisibility('character-area')`で対応する`.left_area`を表示。

```
┌─────────────────────────┐
│ キャラクター管理         │
├─────────────────────────┤
│ [+ 新規キャラ追加]      │
├─────────────────────────┤
│ ┌─────┐ キャラA         │
│ │thumb│ 1girl, long...  │
│ └─────┘ [編集] [挿入]   │
├─────────────────────────┤
│ ┌─────┐ キャラB         │
│ │thumb│ 1boy, short...  │
│ └─────┘ [編集] [挿入]   │
├─────────────────────────┤
│ ┌─────┐ キャラC         │
│ │thumb│ 1girl, twin...  │
│ └─────┘ [編集] [挿入]   │
└─────────────────────────┘
```

### キャラクター編集（フローティングウィンドウ）
[編集]ボタンで`.flow-floating-window`パターンのウィンドウを開く（Workflow Editorと同じ）。

```
┌─────────────────────────────────┐
│ キャラクター編集    [×]         │  ← .flow-window-header
├─────────────────────────────────┤
│ 名前: [サクラ           ]       │
│                                 │
│ サムネイル: [画像選択]          │
│ ┌──────┐                       │
│ │      │                       │
│ └──────┘                       │
│                                 │
│ 基本プロンプト:                 │
│ ┌─────────────────────────┐    │
│ │1girl, long pink hair,   │    │
│ │red eyes, school uniform │    │
│ └─────────────────────────┘    │
│                                 │
│ 表情バリエーション:             │
│ ☑ smile  ☑ angry  ☑ crying    │
│ ☑ surprised  [+ 追加]         │
│                                 │
│ LoRA:                           │
│ モデル: [sakura_v1.safetensors]│
│ トリガー: [sakura]              │
│ ウェイト: [0.8]                 │
│                                 │
│ 参照画像:                       │
│ ┌──┐ ┌──┐ ┌──┐ [+ 追加]      │
│ └──┘ └──┘ └──┘                │
│                                 │
│        [保存]  [キャンセル]     │
└─────────────────────────────────┘
```

### プロンプト挿入フロー
```
1. コマ（Panel）をキャンバスで選択
2. 右パネル(#other-controls-mini)にプロンプト入力欄が表示される（既存動作）
3. サイドバーのキャラパネルで [挿入] ボタンを押す
4. → 右パネルの #basePrompt_prompt にキャラの基本プロンプトが挿入
5. 表情チェックボックスが一時表示 → 選択 → プロンプトに追加
6. LoRAがあれば <lora:name:weight> も自動追加
```

### もう一つの導線: コンテキストメニュー
```
コマを右クリック → Generate横に「キャラ挿入」ドロップダウン
→ 登録キャラ一覧が表示 → クリックで挿入
```

## 該当箇所
- 新規: `js/ai/character/`
  - `character-manager.js` - キャラクター管理
  - `character-panel.js` - サイドバーパネルUI
  - `character-editor.js` - フローティング編集ウィンドウ
- 新規: `js/db/character-repository.js` - IndexedDB永続化
- 修正: `js/sidebar/sidebar.js` - `toggleVisibility()`にcharacter-area追加
- 修正: `index.html` - サイドバーにアイコン追加、`.left_area`パネル追加
- 修正: `js/ai/prompt/` - プロンプト生成にキャラクター情報を統合
- 修正: `js/ui/canvas-object-menu.js` - 「キャラ挿入」ドロップダウン追加

## 影響範囲
- サイドバーに新タブ追加
- AI生成のプロンプト入力フロー
- コンテキストメニュー拡張

## 売りポイント
- マンガ制作で最も重要な「キャラクターの一貫性」問題を解決
- AI生成マンガの最大の弱点（コマごとにキャラが変わる）への直接的な対策
- プロンプト入力の手間を大幅に削減
- LoRA管理まで含めた包括的なキャラ管理は他ツールにない差別化要素
