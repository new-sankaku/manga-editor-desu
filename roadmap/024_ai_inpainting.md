# 024: AIインペインティング / アウトペインティング

## 規模: M (中)

## 概要
画像の選択した領域のみをAIで再生成するインペインティング機能。手や顔の修正、背景の一部変更など、画像全体を再生成せずに部分的な修正を可能にする。アウトペインティング（画像の外側を拡張生成）にも対応。

## 現状の問題
- Image2Imageは画像全体を再生成するため、修正不要な部分も変わってしまう
- 手の描画ミスや顔の微修正のためだけに全体を再生成するのは非効率
- ComfyUIにはInpaint/Outpaintの仕組みがあるが、このエディタからは利用できない

## UI設計

### 操作フロー
```
1. キャンバス上の画像を右クリック
2. コンテキストメニューから「Inpaint」を選択
3. 専用の別キャンバス（インペイントエディタ）が開く
4. マスク描画・プロンプト入力・生成を別キャンバス内で完結
5. 生成結果を確認し「適用」で元キャンバスに反映
```

### インペイントエディタ（別キャンバス）
右クリックメニューからInpaintを選択すると、#canvas-area内に専用のインペイントキャンバスをオーバーレイ表示する。元のキャンバスは背後に隠れるが破棄しない。

```
+------------------------------------------------------------------+
| nav (そのまま)                                                    |
+------------------------------------------------------------------+
|          | インペイントエディタ                   [適用] [戻る]  |
|          | ┌──────────────────────────────────────────────┐       |
|          | │ ツールバー                                    │       |
|          | │ [ブラシ][消しゴム][反転][クリア] サイズ:[==] │       |
|          | │ [Inpaint / Outpaint 切替]                    │       |
|          | ├──────────────────────────────────────────────┤       |
| sidebar  | │                                                │       |
| (非活性) | │    対象画像 + マスクオーバーレイ               │       |
|          | │    （赤半透明でマスク領域を描画）              │       |
|          | │                                                │       |
|          | │    Outpaint時:                                │       |
|          | │    画像の外側に拡張領域が表示される            │       |
|          | │                                                │       |
|          | ├──────────────────────────────────────────────┤       |
|          | │ プロンプト: [                              ] │       |
|          | │ デノイズ:   [====------] 0.75                │       |
|          | │ [Generate]                                    │       |
|          | │                                                │       |
|          | │ 生成結果プレビュー:                           │       |
|          | │ ┌────────┐ ┌────────┐                       │       |
|          | │ │Before  │ │After   │                       │       |
|          | │ └────────┘ └────────┘                       │       |
|          | └──────────────────────────────────────────────┘       |
+------------------------------------------------------------------+
```

### Inpaint / Outpaint切替
- **Inpaint**: 画像内の選択領域を再生成（マスク描画モード）
- **Outpaint**: 画像の外側を拡張生成（上下左右の拡張幅を指定）

### 適用フロー
```
生成結果プレビューで確認 → [適用] ボタン
→ 元キャンバスの画像オブジェクトを生成結果で置き換え
→ インペイントエディタを閉じて元キャンバスに戻る
→ 履歴に1操作として記録（changeDoNotSaveHistory/changeDoSaveHistory）
```

## 修正内容

### インペイントエディタ（別キャンバス）
- 対象画像のみを表示する専用Fabric.jsキャンバスを生成
- マスク描画レイヤー（赤半透明オーバーレイ）
- ブラシツール: サイズ調整、消しゴム、マスク反転、クリア
- Outpaint用の拡張領域設定（上下左右のピクセル数指定）
- プロンプト入力欄、デノイズ強度スライダー
- 生成結果のBefore/Afterプレビュー
- 「適用」で元キャンバスに結果を反映、「戻る」でキャンセル

### ComfyUIワークフロー連携
- **Inpaint/Outpaint用ワークフローカテゴリの新設**
  - 既存カテゴリ: T2I, I2I, Rembg, Upscaler
  - 追加: **Inpaint** カテゴリ
- ワークフローテンプレートの追加
  - 元画像 + マスク画像 + プロンプトをComfyUIに送信
  - `%inpaint_image%`, `%inpaint_mask%` プレースホルダーの追加
  - Outpaint用: `%outpaint_padding_top%`, `%outpaint_padding_bottom%` 等
- ワークフローエディタのタブにInpaintタブを追加
- デノイズ強度の調整（元画像をどの程度残すか）

### コンテキストメニュー
- `canvas-object-menu.js`に「Inpaint」ボタン追加（rembg/upscaleと同列）
- 画像オブジェクト選択時のみ表示

## 該当箇所
- 新規: `js/ai/inpainting/`
  - `inpaint-editor.js` - インペイントエディタ（別キャンバス）
  - `inpaint-mask.js` - マスク描画
  - `inpaint-workflow.js` - ワークフロー連携
- 新規: `js/ai/comfyui/v2/comfyui_workflow/inpaint/` - ワークフローJSON
- 修正: `js/ui/canvas-object-menu.js` - コンテキストメニューに「Inpaint」追加
- 修正: `js/ai/comfyui/v2/comfyui-workflow-editor.js` - Inpaintタブ追加
- 修正: `js/ai/role/ai-roles.js` - Inpaintロール追加

## 影響範囲
- AI生成パイプラインの拡張（新カテゴリ追加）
- ComfyUIワークフローエディタのタブ追加
- キャンバスオブジェクトメニューの追加

## 売りポイント
- AI画像生成の最大の弱点（手、顔、細部）をピンポイントで修正可能
- 「AIで生成→気になる部分だけ修正」というワークフローが完結する
- 別キャンバスで集中して作業できるため、元の編集内容に影響しない
- Inpaint/Outpaint両対応で画像の修正も拡張も可能
- ComfyUIのInpainting機能を直感的なUIで使える唯一のマンガエディタ
